<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fokesto Metadata | Adobe Stock AI Generator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-color: #030014;
      --glass-bg: rgba(16, 18, 27, 0.6);
      --glass-border: rgba(255, 255, 255, 0.08);
      --primary: #8b5cf6;
      --primary-hover: #7c3aed;
      --accent: #10b981;
      --text-main: #f3f4f6;
      --text-muted: #9ca3af;
      --input-bg: rgba(0, 0, 0, 0.3);
      --modal-overlay: rgba(0, 0, 0, 0.75);
    }

    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      background-image:
        radial-gradient(circle at 15% 50%, rgba(139, 92, 246, 0.15), transparent 25%),
        radial-gradient(circle at 85% 30%, rgba(16, 185, 129, 0.15), transparent 25%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* --- Header --- */
    header {
      width: 100%;
      max-width: 1200px;
      padding: 24px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-sizing: border-box;
    }

    .brand {
      display: flex;
      flex-direction: column;
    }

    .brand h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(to right, #fff, #9ca3af);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .brand span {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    button.icon-btn {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      color: var(--text-main);
      padding: 10px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    button.icon-btn:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.2);
    }

    /* --- Main Container --- */
    main {
      width: 100%;
      max-width: 900px;
      padding: 20px;
      box-sizing: border-box;
      flex: 1;
    }

    .glass-card {
      background: var(--glass-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      padding: 32px;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }

    /* --- Controls --- */
    .controls-grid {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 24px;
      margin-bottom: 24px;
      align-items: center;
    }

    .mode-select-wrapper {
      position: relative;
    }

    select.premium-select {
      background: var(--input-bg);
      border: 1px solid var(--glass-border);
      color: var(--text-main);
      padding: 12px 16px;
      border-radius: 12px;
      font-family: inherit;
      font-size: 14px;
      width: 100%;
      cursor: pointer;
      appearance: none;
    }

    label.field-label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    /* --- Dropzone --- */
    .dropzone {
      border: 2px dashed var(--glass-border);
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      transition: all 0.2s;
      background: rgba(255, 255, 255, 0.01);
      margin-bottom: 24px;
      position: relative;
    }

    .dropzone:hover {
      border-color: var(--primary);
      background: rgba(139, 92, 246, 0.05);
    }

    .dropzone input[type="file"] {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      opacity: 0;
      cursor: pointer;
    }

    .dropzone-text h3 {
      font-size: 16px;
      margin: 0 0 4px 0;
      color: var(--text-main);
    }

    .dropzone-text p {
      font-size: 13px;
      color: var(--text-muted);
      margin: 0;
    }

    /* --- Action Bar --- */
    .action-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }

    button.primary-btn {
      background: linear-gradient(135deg, var(--primary), var(--primary-hover));
      border: none;
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.2s;
      flex: 1;
      max-width: 200px;
    }

    button.primary-btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    .status-text {
      font-size: 13px;
      color: var(--text-muted);
      flex: 1;
      text-align: right;
    }

    .error-msg {
      color: #71262d;
      background: #fecaca;
      border: 1px solid #71262d;
      padding: 10px;
      border-radius: 8px;
      font-size: 13px;
      margin-top: 10px;
      display: none;
    }

    /* --- Results Table --- */
    .results-area {
      margin-top: 32px;
      display: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th {
      text-align: left;
      padding: 12px;
      color: var(--text-muted);
      font-weight: 500;
      border-bottom: 1px solid var(--glass-border);
    }

    td {
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
      vertical-align: top;
      color: var(--text-main);
    }

    .text-cell {
      max-width: 300px;
      white-space: pre-wrap;
      line-height: 1.4;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.1);
      font-size: 11px;
    }

    /* --- Modal --- */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--modal-overlay);
      backdrop-filter: blur(4px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }

    .modal-backdrop.active {
      opacity: 1;
      pointer-events: all;
    }

    .modal {
      background: #0f111a;
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      width: 90%;
      max-width: 600px;
      padding: 32px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      max-height: 85vh;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 20px;
    }

    .close-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 24px;
    }

    .api-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      overflow-y: auto;
      padding-right: 8px;
      margin-bottom: 20px;
    }

    .api-grid::-webkit-scrollbar {
      width: 6px;
    }

    .api-grid::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 3px;
    }

    .api-input {
      background: var(--input-bg);
      border: 1px solid var(--glass-border);
      color: var(--text-main);
      padding: 10px;
      border-radius: 8px;
      width: 100%;
      box-sizing: border-box;
      font-family: monospace;
      font-size: 12px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
  </style>
</head>

<body>

  <header>
    <div class="brand">
      <h1>Fokesto Metadata</h1>
      <span>AI-Powered Adobe Stock Helper</span>
    </div>
    <button id="openSettingsBtn" class="icon-btn">
      ⚙️ API Settings
    </button>
  </header>

  <main>
    <div class="glass-card">

      <!-- MODE SELECTOR -->
      <div class="controls-grid">
        <div class="mode-select-wrapper">
          <label class="field-label">Generation Mode</label>
          <select id="mode" class="premium-select">
            <option value="metadata">Adobe Stock Metadata (Title + Keywords)</option>
            <option value="prompt">Image to Prompt (Reverse Engineering)</option>
            <option value="vector">Vector Style Prompt (Flat/Minimalist)</option>

          </select>
        </div>
      </div>

      <!-- FILE UPLOAD -->
      <div class="dropzone">
        <input type="file" id="imageInput" accept="image/*" multiple />
        <div class="dropzone-text">
          <h3>Drop images here or click to upload</h3>
          <p>Supports JPG, PNG (Max 50 images for SVG)</p>
        </div>
      </div>

      <!-- GLOBAL ERROR -->
      <div id="fileError" class="error-msg" style="display:none; margin-bottom:16px;"></div>

      <!-- ACTIONS -->
      <div class="action-bar">
        <button id="generateBtn" class="primary-btn">✨ Generate</button>
        <button id="downloadCsvBtn" class="icon-btn" disabled>Download CSV</button>

        <div id="status" class="status-text">Ready to start</div>
      </div>

      <!-- RESULTS TABLE -->
      <div id="resultsSection" class="results-area">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
          <h3 style="margin:0; font-size:16px;">Results</h3>
          <button id="retryErrorsBtn" class="icon-btn" style="font-size:12px; padding:6px 12px;" disabled>Retry
            Errors</button>
        </div>
        <table>
          <thead>
            <tr>
              <th width="50">#</th>
              <th width="150">File</th>
              <th id="headerTitle">Title / Prompt</th>
              <th id="headerKeywords">Keywords</th>
              <th width="100">Category</th>
            </tr>
          </thead>
          <tbody id="resultsBody"></tbody>
        </table>
      </div>

    </div>
  </main>

  <!-- SETTINGS MODAL -->
  <div class="modal-backdrop" id="settingsModal">
    <div class="modal">
      <div class="modal-header">
        <h2>API Key Configuration</h2>
        <button class="close-btn" id="closeSettingsBtn">×</button>
      </div>

      <p style="font-size:13px; color:var(--text-muted); margin-top:0; margin-bottom:16px;">
        Add up to 20 Groq API keys to distribute the load. Keys are stored locally in your browser.
      </p>

      <div class="api-grid" id="apiKeysGrid">
        <!-- JS will inject inputs here -->
      </div>

      <div id="apiKeyError" class="error-msg" style="margin-bottom:16px;"></div>

      <div class="modal-footer">
        <button class="icon-btn" id="saveKeysBtn" style="background:var(--primary); border:none;">Save & Close</button>
      </div>
    </div>
  </div>

  <script>
    // --- CONSTANTS ---
    const GROQ_MODEL = 'meta-llama/llama-4-scout-17b-16e-instruct';

    // --- DOM ELEMENTS ---
    const els = {
      modal: document.getElementById('settingsModal'),
      openSettings: document.getElementById('openSettingsBtn'),
      closeSettings: document.getElementById('closeSettingsBtn'),
      apiGrid: document.getElementById('apiKeysGrid'),
      saveKeys: document.getElementById('saveKeysBtn'),
      apiKeyError: document.getElementById('apiKeyError'),

      mode: document.getElementById('mode'),
      fileInput: document.getElementById('imageInput'),
      fileError: document.getElementById('fileError'),
      generateBtn: document.getElementById('generateBtn'),
      downloadBtn: document.getElementById('downloadCsvBtn'),

      retryBtn: document.getElementById('retryErrorsBtn'),
      status: document.getElementById('status'),

      resultsSection: document.getElementById('resultsSection'),
      resultsBody: document.getElementById('resultsBody'),
      headerTitle: document.getElementById('headerTitle'),
      headerKeywords: document.getElementById('headerKeywords')
    };

    let apiKeyInputs = [];
    let results = [];
    let svgs = [];
    let lastMode = 'metadata';

    // --- INITIALIZATION ---
    function init() {
      // 1. Create API Inputs
      for (let i = 0; i < 20; i++) {
        const input = document.createElement('input');
        input.type = 'password';
        input.className = 'api-input';
        input.placeholder = `API Key ${i + 1}`;
        els.apiGrid.appendChild(input);
        apiKeyInputs.push(input);
      }

      // 2. Load Keys
      try {
        const raw = localStorage.getItem('groq_api_keys_20');
        if (raw) {
          const list = JSON.parse(raw);
          list.forEach((val, idx) => {
            if (apiKeyInputs[idx]) apiKeyInputs[idx].value = val || '';
          });
        }
      } catch (e) { console.error(e); }

      // 3. Event Listeners
      els.openSettings.addEventListener('click', () => els.modal.classList.add('active'));
      els.closeSettings.addEventListener('click', () => els.modal.classList.remove('active'));

      els.saveKeys.addEventListener('click', () => {
        const values = apiKeyInputs.map(i => i.value.trim());
        if (!values.some(v => v)) {
          els.apiKeyError.style.display = 'block';
          els.apiKeyError.textContent = 'Please enter at least one API Key.';
          return;
        }
        localStorage.setItem('groq_api_keys_20', JSON.stringify(values));
        els.apiKeyError.style.display = 'none';
        els.modal.classList.remove('active');
        els.status.textContent = 'API Keys saved.';
      });

      els.generateBtn.addEventListener('click', startGeneration);
      els.retryBtn.addEventListener('click', retryErrors);
      els.downloadBtn.addEventListener('click', downloadCsv);


      els.mode.addEventListener('change', updateHeaders);
      updateHeaders(); // init
    }

    function updateHeaders() {
      const mode = els.mode.value;
      const isMeta = mode === 'metadata';
      const isSvg = mode === 'svg';

      els.headerTitle.textContent = isMeta ? 'Adobe Stock Title' : 'Prompt';
      els.headerKeywords.textContent = isMeta ? 'Keywords' : '—';
      els.openSettings.style.display = 'flex';
      els.downloadBtn.style.display = 'inline-flex';
    }


    function getKeys() {
      return apiKeyInputs.map(i => i.value.trim()).filter(v => v.length > 0);
    }

    // --- GENERATION LOGIC ---

    async function startGeneration() {
      const mode = els.mode.value;



      const keys = getKeys();
      if (!keys.length) {
        els.modal.classList.add('active');
        els.apiKeyError.textContent = 'Please add at least one API Key to start.';
        els.apiKeyError.style.display = 'block';
        return;
      }

      const files = els.fileInput.files;
      if (!files.length) {
        showError('Please select at least one image.');
        return;
      }
      if (files.length > 500) {
        showError('Max 500 images allowed.');
        return;
      }

      // Reset UI
      els.fileError.style.display = 'none';
      els.resultsSection.style.display = 'block';
      els.resultsBody.innerHTML = '';
      results = [];
      lastMode = els.mode.value;

      els.generateBtn.disabled = true;
      els.downloadBtn.disabled = true;
      els.retryBtn.disabled = true;

      let successCount = 0;

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        els.status.textContent = `Processing ${i + 1}/${files.length}: ${file.name}...`;

        // Round robin attemps
        let data = null;
        let err = null;

        for (let attempt = 0; attempt < keys.length; attempt++) {
          const keyIndex = (i + attempt) % keys.length;
          const key = keys[keyIndex];

          try {
            data = await callGroqParams(key, file, lastMode);
            break;
          } catch (e) {
            console.warn(`Key ${keyIndex} failed:`, e);
            err = e;
          }
        }

        if (data) successCount++;
        appendRow(i, file, data, data ? null : err);
      }

      els.status.textContent = `Done. ${successCount}/${files.length} successful.`;
      els.generateBtn.disabled = false;
      if (successCount > 0) els.downloadBtn.disabled = false;

      const hasErrors = results.some(r => r.error);
      if (hasErrors) els.retryBtn.disabled = false;
    }

    async function retryErrors() {
      const keys = getKeys();
      const files = els.fileInput.files;

      els.retryBtn.disabled = true;
      els.generateBtn.disabled = true;

      for (let i = 0; i < results.length; i++) {
        if (!results[i].error) continue;

        const file = files[i];
        els.status.textContent = `Retrying ${file.name}...`;

        let data = null;
        let err = null;

        for (let attempt = 0; attempt < keys.length; attempt++) {
          const key = keys[(i + attempt) % keys.length];
          try {
            data = await callGroqParams(key, file, lastMode);
            break;
          } catch (e) {
            err = e;
          }
        }

        if (data) {
          // update row
          appendRow(i, file, data, null, true);
        }
      }

      els.status.textContent = 'Retry complete.';
      els.generateBtn.disabled = false;
      els.retryBtn.disabled = !results.some(r => r.error);
    }



    // --- API CALL ---
    async function callGroqParams(apiKey, file, mode) {
      const base64 = await fileToBase64(file);
      const dataUrl = `data:${file.type || 'image/jpeg'};base64,${base64}`;
      const cleanName = file.name.replace(/\.[^.]+$/, '').replace(/[-_]/g, ' ');

      let sys, user;

      if (mode === 'metadata') {
        sys = `You are an Adobe Stock metadata expert. Return JSON ONLY: { "title": "string (100-150 words)", "keywords": ["string", ...30-45 items], "category": "string" }. Title must be descriptive. Keywords must be relevant and ranked. ONE category from standard stock list.`;
        user = `Image filename: ${cleanName}. Generate metadata.`;
      } else if (mode === 'vector') {
        sys = `You are an expert at writing prompts for vector assets. Return JSON ONLY: { "prompt": "string (50-100 words)" }. Describe the image as a flat vector illustration. Emphasize: clean lines, solid colors, no gradients, white background, minimalist style, suitable for Adobe Illustrator or SVG conversion.`;
        user = `Image filename: ${cleanName}. Generate a flat vector art prompt.`;
      } else {
        sys = `You are a prompt engineer. Return JSON ONLY: { "prompt": "string (80-150 words)" }. Describe subject, lighting, style, camera settings.`;
        user = `Image filename: ${cleanName}. Generate image prompt.`;
      }

      const resp = await fetch('https://api.groq.com/openai/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${apiKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          model: GROQ_MODEL,
          messages: [
            { role: 'system', content: sys },
            {
              role: 'user', content: [
                { type: 'text', text: user },
                { type: 'image_url', image_url: { url: dataUrl } }
              ]
            }
          ],
          response_format: { type: 'json_object' },
          temperature: 0.5,
          max_completion_tokens: 500
        })
      });

      if (!resp.ok) throw new Error(`API Error ${resp.status}`);
      const json = await resp.json();
      const content = json.choices[0].message.content;
      return JSON.parse(content);
    }

    // --- HELPERS ---
    function appendRow(index, file, data, err, isUpdate = false) {
      const isMeta = lastMode === 'metadata';

      const rowHtml = `
        <td>${index + 1}</td>
        <td style="word-break:break-all; font-size:12px; opacity:0.8;">${file.name}</td>
        <td class="text-cell">${err ? `<span style="color:#f87171">Error: ${err.message || 'Unknown'}</span>` : (isMeta ? data.title : data.prompt)}</td>
        <td class="text-cell" style="font-size:11px; color:var(--text-muted);">${!err && isMeta ? data.keywords.join(', ') : '—'}</td>
        <td>${!err && isMeta ? `<span class="badge">${data.category}</span>` : '—'}</td>
      `;

      if (isUpdate) {
        const tr = document.querySelector(`tr[data-idx="${index}"]`);
        if (tr) tr.innerHTML = rowHtml;
        results[index] = { ...data, error: err, filename: file.name };
      } else {
        const tr = document.createElement('tr');
        tr.dataset.idx = index;
        tr.innerHTML = rowHtml;
        els.resultsBody.appendChild(tr);
        results.push({ ...data, error: err, filename: file.name });
      }
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function fileToDataUrl(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function showError(msg) {
      els.fileError.textContent = msg;
      els.fileError.style.display = 'block';
    }

    function downloadCsv() {
      if (!results.length) return;

      const isMeta = lastMode === 'metadata';
      const headers = isMeta ? ['Filename', 'Title', 'Keywords', 'Category'] : ['Filename', 'Prompt'];

      const rows = results.map(r => {
        if (r.error) return null;
        if (isMeta) {
          return [clean(r.filename), clean(r.title), clean(r.keywords.join('; ')), clean(r.category)].join(',');
        } else {
          return [clean(r.filename), clean(r.prompt)].join(',');
        }
      }).filter(r => r);

      const csvContent = [headers.join(','), ...rows].join('\r\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `fokesto_${lastMode}_${new Date().getTime()}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function clean(str) {
      return `"${(str || '').replace(/"/g, '""')}"`;
    }

    // Start
    init();

  </script>
</body>

</html>